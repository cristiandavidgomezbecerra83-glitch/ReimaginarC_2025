<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard Celsia — Cobro de Suspensiones (Pro)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#f4f7f9;
      --card:#ffffff;
      --muted:#6b7280;
      --accent-1:#007a5a; /* verde Celsia aproximado */
      --accent-2:#00a0d2; /* azul secundario */
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 6px 18px rgba(16,24,40,0.08);
      --radius:12px;
      --gap:18px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #eef6f5 100%);} 
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:transparent}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:18px;margin:0;color:#0f172a}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .layout{display:grid;grid-template-columns:360px 1fr;gap:var(--gap);padding:18px}

    /* SIDEBAR */
    .sidebar{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);height:calc(100vh - 120px);overflow:auto}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow)}
    .kpi{display:flex;gap:12px;align-items:center}
    .kpi .num{font-size:20px;font-weight:700}
    .kpi small{color:var(--muted);display:block}

    .filters{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    label{font-size:13px;color:var(--muted)}
    select,input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef0}

    /* MAIN */
    main{min-height:80vh}
    .topcards{display:flex;gap:18px;margin-bottom:var(--gap);flex-wrap:wrap}
    .topcard{flex:1;min-width:200px;background:linear-gradient(180deg, #ffffff, #fbfffd);padding:14px;border-radius:12px;box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center}
    .topcard .meta{display:flex;flex-direction:column}
    .trend{font-size:13px;color:var(--muted)}
    .green{color:var(--accent-1);font-weight:700}
    .blue{color:var(--accent-2);font-weight:700}

    .charts{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .table-wrap{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #f2f6f7;text-align:left}
    th{color:var(--muted);font-weight:600}

    footer{padding:18px;color:var(--muted);font-size:13px;text-align:center}

    /* responsive */
    @media (max-width:980px){
      .layout{grid-template-columns:1fr;}
      .charts{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header style="background:#f5f5f5; border-bottom:4px solid #F28C00; display:flex; align-items:center; padding:10px 20px; gap:15px;">
    <img src="https://raw.githubusercontent.com/cristiandavidgomezbecerra83-glitch/ReimaginarC/main/logo-celsia.png" alt="Logo Celsia" style="height:75px;">
    <div>
      <h2 style="margin:0; color:#333; font-weight:600;">Información de Cobro de Suspensiones</h2>
      <p style="margin:0; color:#666; font-size:0.85em;">Idea de Reimaginar_CE</p>
    </div>

    <div style="margin-left:auto; text-align:right;">
      <div class="acumulado" id="acumuladoTotal" style="background:#2f2f2f; color:#d4ffb2; display:inline-block; padding:10px 25px; border-radius:10px; font-size:1.2em; text-align:center;">
        $ 0 mill.<br><small>ACUMULADO ACTUAL</small>
      </div>
      <div>
        <!-- lastUpdated añadido para evitar error JS -->
        <small id="lastUpdated" style="display:block;color:var(--muted);font-size:12px;margin-top:6px;">Última carga: --</small>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="card">
        <div class="kpi">
          <div>
            <div class="num" id="acumuladoLarge">$ 0</div>
            <small>Total Acumulado (COP)</small>
          </div>
          <div style="text-align:right">
            <small class="trend">Ticket promedio</small>
            <div class="num green" id="ticketProm">$ 0</div>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="filters">
          <div>
            <label>Region</label>
            <select id="filterRegion"><option value="ALL">Todos</option><option>VALLE</option><option>TOLIMA</option></select>
          </div>
          <div>
            <label>Sector / Zona</label>
            <select id="filterSector"><option value="ALL">Todos</option></select>
          </div>
          <div>
            <label>Mes</label>
            <select id="filterMes"><option value="ALL">Todos</option></select>
          </div>
          <div>
            <label>Búsqueda rápida</label>
            <input id="quickSearch" placeholder="Sector, Mes...">
          </div>
        </div>
      </div>

      <div style="height:var(--gap)"></div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Top 5 Sectores (by valor)</h3>
        <ol id="topSectores" style="padding-left:18px;margin:0;color:var(--muted)"></ol>
      </div>

      <div style="height:var(--gap)"></div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Notas</h3>
        <p style="margin:0;color:var(--muted);font-size:13px">Datos extraídos desde tu CSV en GitHub. Este dashboard está optimizado para desplegarse en GitHub Pages o un servidor estático. Si quieres logo oficial, súbelo al repo y lo integro.</p>
      </div>
    </aside>

    <main>
      <div class="topcards">
        <div class="topcard">
          <div class="meta">
            <small style="color:var(--muted)">Acumulado (COP)</small>
            <div class="num blue" id="kpiAcum">$ 0</div>
          </div>
          <div style="text-align:right">
            <small style="color:var(--muted)">Crec. (últ. mes)</small>
            <div id="kpiCrec" class="green">0%</div>
          </div>
        </div>

        <div class="topcard">
          <div class="meta">
            <small style="color:var(--muted)">Cant. Suspensiones</small>
            <div class="num" id="kpiCant">0</div>
          </div>
          <div style="text-align:right">
            <small style="color:var(--muted)">Promedio / mes</small>
            <div id="kpiPromMes">0</div>
          </div>
        </div>

        <div class="topcard">
          <div class="meta">
            <small style="color:var(--muted)">Top Sector</small>
            <div class="num" id="kpiTopSector">-</div>
          </div>
          <div style="text-align:right">
            <small style="color:var(--muted)">% del total</small>
            <div id="kpiTopPct">0%</div>
          </div>
        </div>
      </div>

      <div class="charts">
        <div>
          <div class="card" style="margin-bottom:18px">
            <canvas id="chartLinea" height="120"></canvas>
          </div>

          <div class="card table-wrap">
            <h3 style="margin-top:0">Tabla resumen</h3>
            <div style="overflow:auto;max-height:320px">
              <table id="tablaResumen">
                <thead><tr><th>Region</th><th>Sector</th><th>Mes</th><th>Cant</th><th>Valor</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div>
          <div class="card" style="margin-bottom:18px">
            <canvas id="chartBarras" height="220"></canvas>
          </div>

          <div class="card" style="margin-top:18px">
            <h3 style="margin:0 0 8px 0">Distribución por Region</h3>
            <canvas id="chartTorta" height="180"></canvas>
          </div>
        </div>
      </div>

    </main>
  </div>

  <footer>
    Creado para Celsia · Datos: repo GitHub (datos.csv)
  </footer>

  <script>
    // CSV RAW URL CORREGIDA (tu repo actual)
    const URL_CSV = "https://raw.githubusercontent.com/cristiandavidgomezbecerra83-glitch/ReimaginarC/main/datos.csv";

    let datos = [];
    let chartLinea, chartBarras, chartTorta;

    // Helpers
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/).filter(l=>l.trim());
      const rows = lines.slice(1).map(l=>{
        // soporta coma, punto y coma o tab
        const cols = l.split(/[,;\t]+/).map(c=>c.trim());
        return {
          REGION: cols[0] || '',
          SECTOR: cols[1] || '',
          MES: cols[2] || '',
          CANT: parseFloat(cols[3]) || 0,
          VALOR: parseFloat(cols[4]) || 0
        };
      });
      return rows;
    }

    function formatMoney(n){return '$ '+Number(n).toLocaleString('es-CO');}

    // Cargar CSV
    fetch(URL_CSV)
      .then(r=>{ if(!r.ok) throw new Error('No se pudo cargar CSV'); return r.text(); })
      .then(t=>{
        datos = parseCSV(t);
        // actualiza la etiqueta que ahora existe en el HTML
        const now = new Date();
        document.getElementById('lastUpdated').textContent = 'Última carga: ' + now.toLocaleString();
        inicializar();
      }).catch(e=>{
        console.error(e); alert('Error al cargar CSV. Revisa la consola.');
      });

    function inicializar(){
      poblarFiltros();
      renderAll();
      // eventos filtros
      document.getElementById('filterRegion').addEventListener('change',renderAll);
      document.getElementById('filterSector').addEventListener('change',renderAll);
      document.getElementById('filterMes').addEventListener('change',renderAll);
      document.getElementById('quickSearch').addEventListener('input',renderAll);
    }

    function unique(arr,key){return [...new Set(arr.map(x=>x[key]||'').filter(Boolean))];}

    function poblarFiltros(){
      const regiones = unique(datos,'REGION');
      const sectores = unique(datos,'SECTOR');
      const meses = unique(datos,'MES').sort();
      const selS = document.getElementById('filterSector');
      const selM = document.getElementById('filterMes');
      selS.innerHTML = '<option value="ALL">Todos</option>' + sectores.map(s=>`<option>${s}</option>`).join('');
      selM.innerHTML = '<option value="ALL">Todos</option>' + meses.map(m=>`<option>${m}</option>`).join('');
    }

    function aplicarFiltros(){
      const r = document.getElementById('filterRegion').value;
      const s = document.getElementById('filterSector').value;
      const m = document.getElementById('filterMes').value;
      const q = document.getElementById('quickSearch').value.toLowerCase();
      return datos.filter(d=>{
        if(r!=='ALL' && d.REGION!==r) return false;
        if(s!=='ALL' && d.SECTOR!==s) return false;
        if(m!=='ALL' && d.MES!==m) return false;
        if(q){ const hay = (d.SECTOR+' '+d.MES+' '+d.REGION).toLowerCase(); if(!hay.includes(q)) return false; }
        return true;
      });
    }

    function renderAll(){
      const filtrados = aplicarFiltros();
      renderKPIs(filtrados);
      renderTabla(filtrados);
      renderCharts(filtrados);
      renderTopSectores(filtrados);
    }

    function renderKPIs(list){
      const total = list.reduce((a,b)=>a+b.VALOR,0);
      const cant = list.reduce((a,b)=>a+b.CANT,0);
      const months = unique(list,'MES').length || 1;
      const ticket = cant? Math.round(total/cant) : 0;

      document.getElementById('acumuladoLarge').textContent = formatMoney(total);
      document.getElementById('kpiAcum').textContent = formatMoney(total);
      document.getElementById('kpiCant').textContent = cant.toLocaleString();
      document.getElementById('kpiPromMes').textContent = Math.round(cant/months).toLocaleString();
      document.getElementById('ticketProm').textContent = formatMoney(ticket);

      // Top sector
      const bySector = {};
      list.forEach(r=>{ bySector[r.SECTOR] = (bySector[r.SECTOR]||0) + r.VALOR; });
      const entries = Object.entries(bySector).sort((a,b)=>b[1]-a[1]);
      if(entries.length){
        document.getElementById('kpiTopSector').textContent = entries[0][0];
        const pct = Math.round(entries[0][1]/(total||1)*100);
        document.getElementById('kpiTopPct').textContent = pct + '%';
      }else{
        document.getElementById('kpiTopSector').textContent = '-';
        document.getElementById('kpiTopPct').textContent = '0%';
      }
    }

    function renderTabla(list){
      const tbody = document.querySelector('#tablaResumen tbody');
      tbody.innerHTML = list.map(r=>`<tr><td>${r.REGION}</td><td>${r.SECTOR}</td><td>${r.MES}</td><td>${r.CANT}</td><td>${formatMoney(r.VALOR)}</td></tr>`).join('');
    }

    function renderTopSectores(list){
      const bySector = {};
      list.forEach(r=>{ bySector[r.SECTOR] = (bySector[r.SECTOR]||0) + r.VALOR; });
      const entries = Object.entries(bySector).sort((a,b)=>b[1]-a[1]).slice(0,5);
      const ol = document.getElementById('topSectores');
      ol.innerHTML = entries.map(e=>`<li>${e[0]} — ${formatMoney(e[1])}</li>`).join('') || '<li>No hay datos</li>';
    }

    function renderCharts(list){
      // Linea: evolución por mes (total)
      const byMonth = {};
      list.forEach(r=>{ byMonth[r.MES] = (byMonth[r.MES]||0) + r.VALOR; });
      const meses = Object.keys(byMonth).sort();
      const valores = meses.map(m=>byMonth[m]);

      // Barras: top sectores
      const bySector = {};
      list.forEach(r=>{ bySector[r.SECTOR] = (bySector[r.SECTOR]||0) + r.VALOR; });
      const secLabels = Object.keys(bySector).sort((a,b)=>bySector[b]-bySector[a]).slice(0,8);
      const secVals = secLabels.map(s=>bySector[s]);

      // Torta: regiones
      const byRegion = {};
      list.forEach(r=>{ byRegion[r.REGION] = (byRegion[r.REGION]||0) + r.VALOR; });
      const regLabels = Object.keys(byRegion);
      const regVals = regLabels.map(r=>byRegion[r]);

      // Destroy old charts
      if(chartLinea) chartLinea.destroy();
      if(chartBarras) chartBarras.destroy();
      if(chartTorta) chartTorta.destroy();

      const ctxL = document.getElementById('chartLinea');
      chartLinea = new Chart(ctxL,{
        type:'line',data:{labels:meses, datasets:[{label:'Valor (COP)',data:valores,fill:true,tension:0.3,borderWidth:2, borderColor:'var(--accent-2)', backgroundColor:'rgba(0,160,210,0.08)'}]},
        options:{plugins:{legend:{display:false},tooltip:{callbacks:{label(ctx){return formatMoney(ctx.raw);}}}},scales:{y:{ticks:{callback:val=>formatMoney(val)}}}
      });

      const ctxB = document.getElementById('chartBarras');
      chartBarras = new Chart(ctxB,{type:'bar',data:{labels:secLabels,datasets:[{label:'Valor (COP)',data:secVals,backgroundColor:'rgba(0,122,90,0.85)'}]},options:{plugins:{legend:{display:false},tooltip:{callbacks:{label(ctx){return formatMoney(ctx.raw);}}}},scales:{y:{ticks:{callback:val=>formatMoney(val)}}}});

      const ctxT = document.getElementById('chartTorta');
      chartTorta = new Chart(ctxT,{type:'pie',data:{labels:regLabels,datasets:[{data:regVals,backgroundColor:['#007a5a','#00a0d2','#f59e0b','#6b7280']} ]},options:{plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label(ctx){const v = ctx.raw; return ctx.label + ': ' + formatMoney(v);}}}}});
    }

  </script>
</body>
</html>
