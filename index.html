<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Celsia — Ahorro por Región</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f4f7f9; --card:#fff; --muted:#6b7280; --ink:#0f172a;
    --accent-1:#007a5a; --accent-2:#00a0d2; --naranja:#F28C00;
    --shadow:0 6px 18px rgba(16,24,40,.08); --radius:12px; --gap:18px;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system,'Segoe UI',Roboto,Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #eef6f5 100%);}
  header{display:flex;align-items:center;gap:15px;padding:10px 20px;border-bottom:4px solid var(--naranja);background:#f5f5f5}
  header img{height:75px}
  header h2{margin:0;color:#333;font-weight:600}
  header p{margin:0;color:#666;font-size:.85em}
  header .right{margin-left:auto;text-align:right}
  .pill{background:#2f2f2f;color:#d4ffb2;display:inline-block;padding:10px 16px;border-radius:10px;font-size:1.05em}

  .layout{display:grid;grid-template-columns:360px 1fr;gap:var(--gap);padding:18px}
  .sidebar{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);height:calc(100vh - 120px);overflow:auto}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow)}
  .kpi .num{font-size:20px;font-weight:700}
  .filters{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  label{font-size:13px;color:var(--muted)}
  select,button{padding:8px;border-radius:8px;border:1px solid #e6eef0}
  main{min-height:80vh}
  .topcards{display:flex;gap:18px;margin-bottom:var(--gap);flex-wrap:wrap}
  .topcard{flex:1;min-width:220px;background:linear-gradient(180deg,#fff,#fbfffd);padding:14px;border-radius:12px;box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center}

  /* Fila principal: línea (angosta) + tabla (angosta) + barras (pequeña) */
  .row-main{display:grid;grid-template-columns:auto 1fr auto;gap:18px;align-items:start}
  .chart-line-wrap{max-width:620px}
  .chart-line-wrap canvas{width:100% !important; height:240px !important}

  .table-wrap{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);max-width:520px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #f2f6f7;text-align:left}
  th{color:#6b7280;font-weight:600}

  .chart-bar-wrap{max-width:360px}
  .chart-bar-wrap canvas{width:100% !important; height:220px !important}

  footer{padding:18px;color:var(--muted);font-size:13px;text-align:center}
  .region-banner{font-weight:700;color:#0f172a}

  @media (max-width:1400px){
    .row-main{grid-template-columns:1fr}
    .chart-line-wrap,.table-wrap,.chart-bar-wrap{max-width:100%}
  }
</style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/cristiandavidgomezbecerra83-glitch/ReimaginarC/main/logo-celsia.png" alt="Logo Celsia">
    <div>
      <h2>Información de Cobro de Suspensiones</h2>
      <p>Idea de Reimaginar_CE — Campo económico: AHORRO</p>
    </div>
    <div class="right">
      <div class="pill" id="acumuladoTotal">$ 0 mill.<br><small>ACUMULADO ACTUAL</small></div>
      <small id="lastUpdated" style="display:block;color:#6b7280;font-size:12px;margin-top:6px;">Última carga: --</small>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="card">
        <div class="kpi" style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <div>
            <div class="num" id="acumuladoLarge">$ 0</div>
            <small>Total Ahorro (COP)</small>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="filters">
          <div>
            <label for="filterRegion">Región</label>
            <select id="filterRegion"><option value="ALL">Todos</option></select>
          </div>
          <div>
            <label for="filterSector">Sector / Zona</label>
            <select id="filterSector" disabled><option value="ALL">Todos</option></select>
          </div>
          <div>
            <label for="filterMes">Mes</label>
            <select id="filterMes"><option value="ALL">Todos</option></select>
          </div>
          <div class="toolbar" style="margin-top:6px">
            <button id="btnReset">Limpiar filtros</button>
          </div>
        </div>
      </div>
    </aside>

    <main>
      <div class="topcards">
        <div class="topcard">
          <div>
            <small style="color:#6b7280">Total Ahorro (COP)</small>
            <div class="num" id="kpiAcum">$ 0</div>
          </div>
          <div style="text-align:right">
            <small style="color:#6b7280">Crec. (últ. mes)</small>
            <div id="kpiCrec" style="color:var(--accent-1);font-weight:700">0%</div>
          </div>
        </div>

        <div class="topcard">
          <div>
            <small style="color:#6b7280">Cantidad</small>
            <div class="num" id="kpiCant">0</div>
          </div>
          <div style="text-align:right">
            <small style="color:#6b7280">Promedio / mes</small>
            <div id="kpiPromMes">0</div>
          </div>
        </div>
      </div>

      <!-- Vista de una región específica -->
      <section id="panelGlobal">
        <div class="row-main">
          <div class="card chart-line-wrap"><canvas id="chartLinea"></canvas></div>
          <div class="card table-wrap">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <h3 style="margin:0">Tabla resumen</h3><small style="color:#6b7280"><span id="rowsCount">0</span> filas</small>
            </div>
            <div style="overflow:auto;max-height:360px">
              <table id="tablaResumen">
                <thead><tr><th>Región</th><th>Sector</th><th>Mes</th><th>Cant</th><th>Ahorro</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="card chart-bar-wrap"><canvas id="chartBarras"></canvas></div>
        </div>
      </section>

      <!-- Vista separada por región (cuando Región = Todos) -->
      <section id="panelSplit" style="display:none">
        <!-- VALLE -->
        <div class="card" style="margin-bottom:12px"><span class="region-banner">VALLE</span></div>
        <div class="row-main" style="margin-bottom:18px">
          <div class="card chart-line-wrap"><canvas id="chartLineaV"></canvas></div>
          <div class="card table-wrap">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <h3 style="margin:0">Tabla VALLE</h3><small style="color:#6b7280"><span id="rowsCountV">0</span> filas</small>
            </div>
            <div style="overflow:auto;max-height:300px">
              <table id="tablaResumenV"><thead><tr><th>Sector</th><th>Mes</th><th>Cant</th><th>Ahorro</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
          <div class="card chart-bar-wrap"><canvas id="chartBarrasV"></canvas></div>
        </div>

        <!-- TOLIMA -->
        <div class="card" style="margin-bottom:12px"><span class="region-banner">TOLIMA</span></div>
        <div class="row-main" style="margin-bottom:18px">
          <div class="card chart-line-wrap"><canvas id="chartLineaT"></canvas></div>
          <div class="card table-wrap">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <h3 style="margin:0">Tabla TOLIMA</h3><small style="color:#6b7280"><span id="rowsCountT">0</span> filas</small>
            </div>
            <div style="overflow:auto;max-height:300px">
              <table id="tablaResumenT"><thead><tr><th>Sector</th><th>Mes</th><th>Cant</th><th>Ahorro</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
          <div class="card chart-bar-wrap"><canvas id="chartBarrasT"></canvas></div>
        </div>
      </section>

    </main>
  </div>

  <footer>Creado para Celsia · Datos insertados · Campo económico: AHORRO</footer>

<script>
/* ==== DATOS QUEMADOS ==== */
const datos = [
  { REGION:'VALLE',  SECTOR:'CENTRO',       MES:'abril', CANT:200, AHORRO:15000000 },
  { REGION:'VALLE',  SECTOR:'NORTE',        MES:'abril', CANT:300, AHORRO:18000000 },
  { REGION:'VALLE',  SECTOR:'PACIFICO',     MES:'mayo',  CANT:400, AHORRO:25000000 },
  { REGION:'VALLE',  SECTOR:'SUR',          MES:'junio', CANT:350, AHORRO:18000000 },
  { REGION:'TOLIMA', SECTOR:'Zona Centro',  MES:'abril', CANT:150, AHORRO: 8000000 },
  { REGION:'TOLIMA', SECTOR:'Zona Norte',   MES:'mayo',  CANT:200, AHORRO:11000000 },
  { REGION:'TOLIMA', SECTOR:'Zona Sur',     MES:'junio', CANT:250, AHORRO:13000000 },
  { REGION:'TOLIMA', SECTOR:'Zona Oriente', MES:'julio', CANT:180, AHORRO: 6000000 },
];
/* ========================= */

let charts = {};
const MESES_ORD = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
const fmtMoney = n => '$ '+Number(n||0).toLocaleString('es-CO');
const uniq = (arr,key) => [...new Set(arr.map(x=>x[key]).filter(Boolean))];
const cap = s => (s||'').charAt(0).toUpperCase()+String(s).slice(1).toLowerCase();

/* ====== FILTROS ====== */
function poblarFiltrosIniciales(){
  // Región
  const regSel = document.getElementById('filterRegion');
  uniq(datos,'REGION').forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; regSel.appendChild(o); });

  // Meses (global ALL por defecto)
  actualizarMeses('ALL');

  // Sector: deshabilitado cuando ALL
  actualizarSectores('ALL');
}

function actualizarSectores(region){
  const sectorSel = document.getElementById('filterSector');
  const disabled = (region === 'ALL');
  sectorSel.disabled = disabled;

  let opciones = [];
  if(region === 'VALLE'){
    opciones = ['CENTRO','NORTE','PACIFICO','SUR'];
  }else if(region === 'TOLIMA'){
    opciones = ['Zona Centro','Zona Norte','Zona Sur','Zona Oriente'];
  }

  if(disabled){
    sectorSel.innerHTML = '<option value="ALL">Todos</option>';
    sectorSel.value = 'ALL';
  }else{
    sectorSel.innerHTML = '<option value="ALL">Todos</option>' + opciones.map(s=>`<option value="${s}">${s}</option>`).join('');
    sectorSel.value = 'ALL';
  }
}

function actualizarMeses(region){
  const mesSel = document.getElementById('filterMes');
  let fuente = datos;
  if(region !== 'ALL'){ fuente = datos.filter(d=>d.REGION===region); }
  const meses = uniq(fuente,'MES').sort((a,b)=> MESES_ORD.indexOf(a.toLowerCase())-MESES_ORD.indexOf(b.toLowerCase()));
  mesSel.innerHTML = '<option value="ALL">Todos</option>' + meses.map(m=>`<option value="${m}">${cap(m)}</option>`).join('');
  mesSel.value = 'ALL';
}

/* ====== DATA VIEW ====== */
function filtrarBase(region){
  const sector = document.getElementById('filterSector').value;
  const mes = document.getElementById('filterMes').value;

  return datos.filter(d=>{
    if(region !== 'ALL' && d.REGION !== region) return false;
    if(sector !== 'ALL' && d.SECTOR !== sector) return false;
    if(mes !== 'ALL' && d.MES !== mes) return false;
    return true;
  });
}

/* ====== RENDER PRINCIPAL ====== */
function render(){
  const region = document.getElementById('filterRegion').value;

  if(region==='ALL'){
    document.getElementById('panelGlobal').style.display = 'none';
    document.getElementById('panelSplit').style.display = '';

    const base = filtrarBase('ALL'); // aplica Mes (si hay)
    const valle = base.filter(d=>d.REGION==='VALLE');
    const tolima = base.filter(d=>d.REGION==='TOLIMA');

    renderKPIsStatic();        // acumulados fijos
    renderKPIsDinamic(base);   // Cant, Prom, Crec del conjunto mostrado
    renderRegionPanels('V', valle, 'VALLE');
    renderRegionPanels('T', tolima, 'TOLIMA');
  }else{
    document.getElementById('panelGlobal').style.display = '';
    document.getElementById('panelSplit').style.display = 'none';

    const list = filtrarBase(region);
    renderKPIsStatic();
    renderKPIsDinamic(list);
    renderTabla('#tablaResumen tbody', '#rowsCount', list, false, region);
    renderCharts({ lineaId:'chartLinea', barrasId:'chartBarras', list, region });
  }
}

function renderRegionPanels(sufijo, list, regionName){
  renderTabla(`#tablaResumen${sufijo} tbody`, `#rowsCount${sufijo}`, list, true, regionName);
  renderCharts({
    lineaId:`chartLinea${sufijo}`,
    barrasId:`chartBarras${sufijo}`,
    list,
    region: regionName
  });
}

/* ====== KPIs ====== */
function renderKPIsStatic(){
  const totalAll = datos.reduce((a,b)=>a+(b.AHORRO||0),0);
  document.getElementById('acumuladoTotal').innerHTML = fmtMoney(totalAll)+"<br><small>ACUMULADO ACTUAL</small>";
  document.getElementById('acumuladoLarge').textContent = fmtMoney(totalAll);
  document.getElementById('kpiAcum').textContent = fmtMoney(totalAll);
}

function renderKPIsDinamic(list){
  const cant  = list.reduce((a,b)=>a+(b.CANT||0),0);
  const months = uniq(list,'MES').length||1;

  document.getElementById('kpiCant').textContent = (cant||0).toLocaleString();
  document.getElementById('kpiPromMes').textContent = Math.round((cant||0)/months).toLocaleString();

  const byM={}; list.forEach(r=>{ byM[r.MES]=(byM[r.MES]||0)+(r.AHORRO||0); });
  const orden = Object.keys(byM).sort((a,b)=> MESES_ORD.indexOf(a.toLowerCase())-MESES_ORD.indexOf(b.toLowerCase()));
  let last=0, prev=0;
  if(orden.length>=1) last = byM[orden[orden.length-1]]||0;
  if(orden.length>=2) prev = byM[orden[orden.length-2]]||0;
  const crec = prev? Math.round((last-prev)/prev*100):0;
  document.getElementById('kpiCrec').textContent = (crec>=0?'+':'')+crec+'%';
}

/* ====== TABLA ====== */
function renderTabla(tbodySel, countSel, list, omitRegion, regionName){
  const mesSel = document.getElementById('filterMes').value;
  const sectorSel = document.getElementById('filterSector').value;
  const tbody = document.querySelector(tbodySel);

  // referencia meses/sectores de la región para no perder filas
  const mesesRef = (regionName && regionName!=='ALL')
      ? uniq(datos.filter(d=>d.REGION===regionName),'MES').sort((a,b)=> MESES_ORD.indexOf(a.toLowerCase())-MESES_ORD.indexOf(b.toLowerCase()))
      : uniq(list,'MES').sort((a,b)=> MESES_ORD.indexOf(a.toLowerCase())-MESES_ORD.indexOf(b.toLowerCase()));

  const sectoresRef = (regionName && regionName!=='ALL')
      ? sectoresPorRegion(regionName)
      : uniq(list,'SECTOR');

  let filas = [];

  if(sectorSel==='ALL'){
    if(mesSel==='ALL'){
      // Totales por sector (suma de todos los meses)
      sectoresRef.forEach(sec=>{
        const rowsSec = list.filter(x=>x.SECTOR===sec);
        const regionRow = regionName || (rowsSec[0]?.REGION || '');
        const sumCant = rowsSec.reduce((a,b)=>a+(b.CANT||0),0);
        const sumAho  = rowsSec.reduce((a,b)=>a+(b.AHORRO||0),0);
        filas.push({REGION:regionRow, SECTOR:sec, MES:'Todos', CANT:sumCant, AHORRO:sumAho});
      });
    }else{
      // Mes específico para TODOS los sectores (si no hay dato, 0)
      sectoresRef.forEach(sec=>{
        const m = list.find(x=>x.SECTOR===sec && x.MES===mesSel);
        if(m) filas.push({REGION:m.REGION, SECTOR:sec, MES:mesSel, CANT:m.CANT||0, AHORRO:m.AHORRO||0});
        else  filas.push({REGION:regionName||'', SECTOR:sec, MES:mesSel, CANT:0, AHORRO:0});
      });
    }
  }else{
    // Sector específico
    if(mesSel==='ALL'){
      // Mostrar TODOS los meses con 0 donde no haya
      mesesRef.forEach(m=>{
        const r = list.find(x=>x.SECTOR===sectorSel && x.MES===m);
        if(r) filas.push({REGION:r.REGION, SECTOR:sectorSel, MES:m, CANT:r.CANT||0, AHORRO:r.AHORRO||0});
        else  filas.push({REGION:regionName||'', SECTOR:sectorSel, MES:m, CANT:0, AHORRO:0});
      });
    }else{
      // Solo ese mes para el sector (0 si no hay)
      const r = list.find(x=>x.SECTOR===sectorSel && x.MES===mesSel);
      if(r) filas.push({REGION:r.REGION, SECTOR:sectorSel, MES:mesSel, CANT:r.CANT||0, AHORRO:r.AHORRO||0});
      else  filas.push({REGION:regionName||'', SECTOR:sectorSel, MES:mesSel, CANT:0, AHORRO:0});
    }
  }

  // Orden por Ahorro desc salvo vista sector-específico & mes=ALL (ahí orden por mes)
  if(!(sectorSel!=='ALL' && mesSel==='ALL')){
    filas.sort((a,b)=> (b.AHORRO - a.AHORRO));
  }

  const rowsHTML = filas.map(r=>`
    <tr>
      ${omitRegion ? '' : `<td>${r.REGION}</td>`}
      <td>${r.SECTOR}</td>
      <td>${r.MES==='Todos'?'Todos':cap(r.MES)}</td>
      <td>${r.CANT}</td>
      <td>${fmtMoney(r.AHORRO)}</td>
    </tr>
  `).join('');

  tbody.innerHTML = rowsHTML || `<tr><td colspan="${omitRegion?4:5}" style="color:#999">Sin datos</td></tr>`;
  const countEl = document.querySelector(countSel);
  if(countEl) countEl.textContent = filas.length;
}

/* ====== CHARTS (línea + barras naranja) ====== */
function renderCharts({lineaId,barrasId,list,region}){
  [lineaId,barrasId].forEach(id=>{ if(charts[id]){ charts[id].destroy(); delete charts[id]; }});

  const mesSel = document.getElementById('filterMes').value;
  const sectorSel = document.getElementById('filterSector').value;

  // --- Línea por mes (si sector específico, la serie es del sector; si no, total de la región)
  const mesesRef = (region && region!=='ALL')
      ? uniq(datos.filter(d=>d.REGION===region),'MES').sort((a,b)=> MESES_ORD.indexOf(a.toLowerCase())-MESES_ORD.indexOf(b.toLowerCase()))
      : uniq(list,'MES').sort((a,b)=> MESES_ORD.indexOf(a.toLowerCase())-MESES_ORD.indexOf(b.toLowerCase()));

  const byMonth = {}; mesesRef.forEach(m=>byMonth[m]=0);
  if(sectorSel==='ALL'){
    list.forEach(r=>{ byMonth[r.MES] = (byMonth[r.MES]||0) + (r.AHORRO||0); });
  }else{
    mesesRef.forEach(m=>{
      const r = list.find(x=>x.SECTOR===sectorSel && x.MES===m);
      byMonth[m] = r ? (r.AHORRO||0) : 0;
    });
  }

  charts[lineaId] = new Chart(document.getElementById(lineaId),{
    type:'line',
    data:{ labels:mesesRef.map(cap), datasets:[{ label:'Ahorro (COP)', data:mesesRef.map(m=>byMonth[m]), fill:true, tension:.3, borderWidth:2, borderColor:getComputedStyle(document.documentElement).getPropertyValue('--accent-2')||'#00a0d2', backgroundColor:'rgba(0,160,210,.08)' }]},
    options:{ plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:c=>fmtMoney(c.raw) } } }, scales:{ y:{ ticks:{ callback:v=>fmtMoney(v) } } } }
  });

  // --- Barras
  if(sectorSel==='ALL'){
    // Barras por SECTOR
    const sectoresRef = region? sectoresPorRegion(region) : uniq(list,'SECTOR');
    const bySector={}; sectoresRef.forEach(s=>bySector[s]=0);
    if(mesSel==='ALL'){
      list.forEach(r=>{ bySector[r.SECTOR] = (bySector[r.SECTOR]||0) + (r.AHORRO||0); });
    }else{
      list.filter(r=>r.MES===mesSel).forEach(r=>{ bySector[r.SECTOR] = (bySector[r.SECTOR]||0) + (r.AHORRO||0); });
      sectoresRef.forEach(s=>{ if(!(s in bySector)) bySector[s]=0; });
    }
    const labels = Object.keys(bySector);
    const values = labels.map(l=>bySector[l]);

    charts[barrasId] = new Chart(document.getElementById(barrasId),{
      type:'bar',
      data:{ labels, datasets:[{ label:(mesSel==='ALL'?'Total ':'Mes '+cap(mesSel)+' ')+'Ahorro (COP)', data:values, backgroundColor:'rgba(242,140,0,0.9)' }]},
      options:{ plugins:{legend:{display:false}, tooltip:{callbacks:{label:c=>fmtMoney(c.raw)}}}, scales:{ y:{ ticks:{ callback:v=>fmtMoney(v) } } } }
    });

  }else{
    // Barras por MES del sector seleccionado
    const values = mesesRef.map(m=>{
      const r = list.find(x=>x.SECTOR===sectorSel && x.MES===m);
      return r ? (r.AHORRO||0) : 0;
    });

    charts[barrasId] = new Chart(document.getElementById(barrasId),{
      type:'bar',
      data:{ labels:mesesRef.map(cap), datasets:[{ label:'Ahorro (COP) — '+sectorSel, data:values, backgroundColor:'rgba(242,140,0,0.9)' }]},
      options:{ plugins:{legend:{display:false}, tooltip:{callbacks:{label:c=>fmtMoney(c.raw)}}}, scales:{ y:{ ticks:{ callback:v=>fmtMoney(v) } } } }
    });
  }
}

/* ====== Utilidades ====== */
function sectoresPorRegion(region){
  return region==='VALLE'
    ? ['CENTRO','NORTE','PACIFICO','SUR']
    : ['Zona Centro','Zona Norte','Zona Sur','Zona Oriente'];
}

/* ====== INIT ====== */
function init(){
  poblarFiltrosIniciales();

  document.getElementById('filterRegion').addEventListener('change', (e)=>{
    const region = e.target.value;
    actualizarSectores(region);
    actualizarMeses(region);
    render();
  });
  document.getElementById('filterSector').addEventListener('change', render);
  document.getElementById('filterMes').addEventListener('change', render);
  document.getElementById('btnReset').addEventListener('click', ()=>{
    document.getElementById('filterRegion').value='ALL';
    actualizarSectores('ALL');
    actualizarMeses('ALL');
    render();
  });

  document.getElementById('lastUpdated').textContent = 'Última carga: '+(new Date()).toLocaleString();

  // Pintado inicial
  renderKPIsStatic();
  render();
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
